<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NasralGram</title>
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1E1E1E;
            --bg-tertiary: #2A2A2A;
            --bg-hover: #333333;
            --text-primary: #E0E0E0;
            --text-secondary: #A0A0A0;
            --border-color: #383838;
            --accent-primary: #7c3aed; /* Violet */
            --accent-secondary: #a78bfa; /* Lighter Violet */
            --error-color: #f43f5e; /* Rose */
            --success-color: #22c55e;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* --- Base & Scrollbar --- */
        * { box-sizing: border-box; }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        body {
            font-family: var(--font-main);
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* --- Auth Page Redesign --- */
        #auth-view {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: #121212;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.1) 1px, transparent 0);
            background-size: 20px 20px;
            animation: move-bg 10s linear infinite;
        }
        @keyframes move-bg {
            from { background-position: 0 0; }
            to { background-position: 40px 40px; }
        }
        .auth-container {
            width: 90%; max-width: 400px; background: rgba(30, 30, 30, 0.85);
            padding: 2.5rem; border-radius: 16px; backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0,0,0,0.6); text-align: center;
        }
        .auth-container h1 {
            font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;
            background: -webkit-linear-gradient(45deg, var(--accent-secondary), #fff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .auth-container p { color: var(--text-secondary); margin-bottom: 2rem; }
        .auth-container .input-field {
            width: 100%; padding: 1rem; margin-bottom: 1rem; background: var(--bg-tertiary);
            border: 1px solid var(--border-color); color: var(--text-primary);
            border-radius: 8px; font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .auth-container .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.3);
        }
        .auth-container .auth-button {
            width: 100%; padding: 1rem; background: var(--accent-primary); color: white;
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem;
            transition: background-color 0.2s, transform 0.1s;
        }
        .auth-container .auth-button:hover { background: var(--accent-secondary); }
        .auth-container .auth-button:active { transform: scale(0.98); }
        .auth-container .switch-link { margin-top: 1.5rem; cursor: pointer; color: var(--text-secondary); font-size: 0.9em; }
        .auth-container .switch-link span { color: var(--accent-secondary); text-decoration: none; font-weight: 500;}
        .auth-container .switch-link:hover span { text-decoration: underline; }
        .auth-container .error {
            color: var(--error-color); background: rgba(244, 63, 94, 0.1);
            text-align: center; margin-bottom: 1rem; padding: 0.75rem;
            border-radius: 8px; font-size: 0.9em;
            border: 1px solid rgba(244, 63, 94, 0.3);
        }

        /* --- Main App Layout --- */
        #app-container {
            display: flex; width: 100%; height: 100%; max-width: 1600px;
            background: var(--bg-secondary); overflow: hidden;
            position: relative; /* For mobile view transitions */
        }
        #side-panel {
            width: 320px; background: var(--bg-primary); display: flex;
            flex-direction: column; border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out;
        }
        #main-panel { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg-secondary); transition: transform 0.3s ease-in-out;}
        
        /* --- Side Panel (Chat List) --- */
        .side-panel-header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .side-panel-header h3 { margin: 0; font-size: 1.2rem; }
        .side-panel-header .header-buttons button { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; margin-left: 0.5rem; padding: 0.25rem; transition: color 0.2s; }
        .side-panel-header .header-buttons button:hover { color: var(--text-primary); }
        #chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s; }
        .chat-item:hover { background: var(--bg-hover); }
        .chat-item.active { background: var(--accent-primary); }
        .chat-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--bg-tertiary); margin-right: 1rem; object-fit: cover; flex-shrink: 0; }
        .chat-info { flex-grow: 1; overflow: hidden; }
        .chat-name { font-weight: bold; white-space: nowrap; }
        .chat-preview { font-size: 0.9em; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Main Panel (Chat View) --- */
        .chat-header { padding: 1rem; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); background: var(--bg-secondary); z-index: 10; }
        .back-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; margin-right: 1rem; cursor: pointer; }
        .chat-header h4 { margin: 0; }
        #message-list { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; }
        .message-input-area { padding: 1rem; border-top: 1px solid var(--border-color); display: flex; align-items: center; background: var(--bg-secondary); }
        #message-input-form { display: flex; flex-grow: 1; align-items: center; background: var(--bg-tertiary); border-radius: 24px; padding: 0.25rem 0.5rem; }
        #message-input { flex-grow: 1; background: transparent; border: none; color: var(--text-primary); padding: 0.75rem; resize: none; outline: none; font-size: 1rem; }
        #message-input-form button { background: var(--accent-primary); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 0.5rem; cursor: pointer; font-size: 1.2rem; flex-shrink: 0; transition: background-color 0.2s;}
        #message-input-form button:hover { background: var(--accent-secondary); }
        #file-input-label { cursor: pointer; padding: 0.5rem; margin-right: 0.5rem; font-size: 1.5rem; color: var(--text-secondary); transition: color 0.2s;}
        #file-input-label:hover { color: var(--text-primary); }

        /* --- Messages --- */
        .message-container { display: flex; margin-bottom: 1rem; max-width: 75%; align-items: flex-end;}
        .message-container.sent { margin-left: auto; flex-direction: row-reverse; }
        .message-bubble { background: var(--bg-tertiary); padding: 0.75rem 1rem; border-radius: 18px; }
        .message-container.sent .message-bubble { background: var(--accent-primary); color: white; }
        .message-sender { font-weight: bold; font-size: 0.8em; margin-bottom: 0.25rem; color: var(--accent-secondary); }
        .message-container.sent .message-sender { display: none; }
        .message-content img { max-width: 100%; border-radius: 12px; margin-top: 5px; cursor: pointer; }
        .message-content a { color: #8ab4f8; text-decoration: none; }
        .message-content a:hover { text-decoration: underline; }
        .message-content.ai-response { border-left: 3px solid #fbbc05; padding-left: 10px; background: rgba(251, 188, 5, 0.05); }
        .timestamp { font-size: 0.7em; color: var(--text-secondary); margin-top: 4px; text-align: right; }

        /* --- Profile Panel --- */
        #profile-panel {
            width: 350px; background: var(--bg-primary); border-left: 1px solid var(--border-color);
            padding: 2rem; display: flex; flex-direction: column; align-items: center;
            position: absolute; right: 0; top: 0; height: 100%;
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
            z-index: 100;
        }
        #profile-panel.visible { transform: translateX(0); }
        #profile-panel-avatar { width: 128px; height: 128px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; border: 2px solid var(--border-color); }
        #profile-panel h3 { margin: 0 0 0.5rem 0; }
        #profile-panel p { color: var(--text-secondary); text-align: center; }
        .close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }

        /* --- Modals --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; justify-content: center;
            align-items: center; z-index: 200; backdrop-filter: blur(5px);
        }
        .modal {
            background: var(--bg-secondary); padding: 2rem; border-radius: 12px;
            width: 90%; max-width: 450px; border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal h2 { margin-top: 0; }
        .modal input, .modal textarea {
            width: 100%; padding: 0.75rem; margin-bottom: 1rem; background: var(--bg-primary);
            border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;
        }
        .modal textarea { min-height: 80px; }
        .modal .modal-actions { display: flex; justify-content: flex-end; margin-top: 1.5rem; }
        .modal button { padding: 0.6rem 1.2rem; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 1rem; }
        .modal .cancel-btn { background: var(--bg-tertiary); }

        /* --- Responsive Design --- */
        .hidden-desktop { display: none; }
        @media (max-width: 900px) {
            #profile-panel { width: 300px; }
        }
        @media (max-width: 768px) {
            .hidden-mobile { display: none; }
            .hidden-desktop { display: block; }
            #app-container { flex-direction: column; }
            #side-panel {
                width: 100%; height: 100%; border-right: none;
                position: absolute; transform: translateX(0); z-index: 20;
            }
            #main-panel {
                width: 100%; height: 100%; position: absolute;
                transform: translateX(100%); z-index: 30;
            }
            #app-container.chat-view-active #side-panel { transform: translateX(-100%); }
            #app-container.chat-view-active #main-panel { transform: translateX(0); }

            #profile-panel { width: 100%; z-index: 100; }
            #profile-panel.visible { box-shadow: -10px 0 20px rgba(0,0,0,0.3); }
        }
    </style>
</head>
<body>

    <!-- Auth View -->
    <div id="auth-view">
        <div class="auth-container">
            <!-- Register View (Default) -->
            <div id="register-view">
                <h1>NasralGram</h1>
                <p>Create an account to start messaging.</p>
                <form id="register-form">
                    <div id="register-error" class="error hidden"></div>
                    <input type="text" id="register-username" class="input-field" placeholder="Username" required>
                    <input type="password" id="register-password" class="input-field" placeholder="Password" required>
                    <button type="submit" class="auth-button">Create Account & Enter</button>
                </form>
                <div class="switch-link" onclick="showAuthForm('login-view')">
                    Already have an account? <span>Log In</span>
                </div>
            </div>

            <!-- Login View -->
            <div id="login-view" class="hidden">
                <h1>NasralGram</h1>
                <p>Welcome back! Sign in to continue.</p>
                <form id="login-form">
                    <div id="login-error" class="error hidden"></div>
                    <input type="text" id="login-username" class="input-field" placeholder="Username" required>
                    <input type="password" id="login-password" class="input-field" placeholder="Password" required>
                    <button type="submit" class="auth-button">Log In</button>
                </form>
                <div class="switch-link" onclick="showAuthForm('register-view')">
                    Don't have an account? <span>Sign Up</span>
                </div>
            </div>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div id="side-panel">
            <div class="side-panel-header">
                <h3 id="current-username-display"></h3>
                <div class="header-buttons">
                    <button onclick="showNewChatModal()" title="New Chat">‚ûï</button>
                    <button onclick="showSettingsModal()" title="Settings">‚öôÔ∏è</button>
                </div>
            </div>
            <div id="chat-list"></div>
        </div>
        <div id="main-panel">
            <div class="chat-header">
                <button id="back-to-chats" class="back-btn hidden-desktop">‚Üê</button>
                <h4 id="chat-title">Select a chat to start messaging</h4>
            </div>
            <div id="message-list"></div>
            <div class="message-input-area">
                <form id="message-input-form">
                    <label for="file-input" id="file-input-label" title="Attach file">üìé</label>
                    <input type="file" id="file-input" class="hidden">
                    <textarea id="message-input" rows="1" placeholder="Type a message..."></textarea>
                    <button type="submit" title="Send">‚û§</button>
                </form>
            </div>
        </div>
        <div id="profile-panel"> <!-- Initially hidden via transform -->
            <button class="close-btn" onclick="hideProfilePanel()">√ó</button>
            <img id="profile-panel-avatar" src="" alt="Profile Picture">
            <h3 id="profile-panel-username"></h3>
            <p id="profile-panel-bio"></p>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="new-chat-modal" class="modal-backdrop hidden">
        <div class="modal">
            <h2>New Chat</h2>
            <form id="new-chat-form">
                <input type="text" id="new-chat-usernames" placeholder="Usernames (comma-separated)">
                <input type="text" id="new-chat-group-name" placeholder="Group Name (optional for groups)">
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="hideNewChatModal()">Cancel</button>
                    <button type="submit">Create Chat</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-backdrop hidden">
        <div class="modal">
            <h2>Settings</h2>
            <form id="settings-form">
                <p>Update your profile:</p>
                <textarea id="settings-bio" placeholder="Your bio..."></textarea>
                <label for="settings-pfp">Update Profile Picture:</label>
                <input type="file" id="settings-pfp" accept="image/*">
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="hideSettingsModal()">Cancel</button>
                    <button type="submit">Save Changes</button>
                </div>
            </form>
            <hr style="border-color: var(--border-color); margin: 2rem 0;">
            <button onclick="logout()" style="background-color: var(--error-color);">Logout</button>
        </div>
    </div>


    <script>
        const API_URL = 'https://nasralgram.onrender.com';
        let state = {
            token: null,
            currentUsername: null,
            activeChatId: null,
            chats: [],
            messages: {}, // { chatId: [message, ...] }
            lastMessageId: {}, // { chatId: lastId }
            pollingInterval: null,
            syncInterval: null,
            messageQueue: [], // Messages to be sent in a batch
        };

        // --- UTILS & HELPERS ---
        function showView(viewId) {
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showAuthForm(formId) {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('register-view').classList.add('hidden');
            document.getElementById(formId).classList.remove('hidden');
        }

        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (state.token) {
                headers['x-access-token'] = state.token;
            }
            try {
                const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
                
                const contentType = response.headers.get("content-type");
                let data;
                
                if (contentType && contentType.includes("application/json")) {
                    data = await response.json();
                } else {
                    const textData = await response.text();
                    if (!response.ok) {
                        console.error("Non-JSON error response from server:", textData);
                        throw new Error(`Server returned an error. Check console for details. (Status: ${response.status})`);
                    }
                    return textData; // For successful non-json responses
                }

                if (!response.ok) {
                    if (response.status === 401) logout();
                    throw new Error(data.message || 'An unknown API error occurred.');
                }
                return data;
            } catch (error) {
                // Catches network errors and errors thrown from above
                console.error(`API Fetch Error for endpoint ${endpoint}:`, error);
                throw error; // Re-throw to be caught by the calling function
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        // --- AUTH ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            try {
                errorEl.classList.add('hidden');
                const data = await apiFetch('/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                state.token = data.token;
                state.currentUsername = data.username;
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('username', data.username);
                await initializeApp();
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');
            errorEl.classList.add('hidden');

            try {
                // Step 1: Register the user
                await apiFetch('/register', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });

                // Step 2: Automatically log in the user with the same credentials
                const data = await apiFetch('/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                
                // Step 3: Store credentials and initialize the app
                state.token = data.token;
                state.currentUsername = data.username;
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('username', data.username);
                await initializeApp();

            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            }
        });
        
        function logout() {
            localStorage.clear();
            state = { token: null, currentUsername: null, activeChatId: null, chats: [], messages: {}, lastMessageId: {}, messageQueue: [] };
            clearInterval(state.pollingInterval);
            clearInterval(state.syncInterval);
            showView('auth-view');
            showAuthForm('register-view'); // Default to register view on logout
            document.getElementById('app-container').classList.remove('chat-view-active');
        }

        // --- RENDERING ---
        function renderChatList() {
            const chatListEl = document.getElementById('chat-list');
            chatListEl.innerHTML = '';
            state.chats.sort((a,b) => new Date(b.last_message_time || 0) - new Date(a.last_message_time || 0));
            state.chats.forEach(chat => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                if (chat.id === state.activeChatId) item.classList.add('active');
                item.onclick = () => selectChat(chat.id);
                
                const avatarSrc = chat.profile_picture ? `data:image/png;base64,${chat.profile_picture}` : `https://api.dicebear.com/7.x/initials/svg?seed=${chat.name}`;
                
                item.innerHTML = `
                    <img src="${avatarSrc}" class="chat-avatar">
                    <div class="chat-info">
                        <div class="chat-name">${chat.name}</div>
                        <div class="chat-preview">${chat.last_message || ''}</div>
                    </div>
                `;
                chatListEl.appendChild(item);
            });
        }
        
        function renderMessages() {
            if (!state.activeChatId) return;
            const messageListEl = document.getElementById('message-list');
            messageListEl.innerHTML = '';
            const messages = state.messages[state.activeChatId] || [];
            messages.forEach(msg => {
                appendMessage(msg, false); // don't scroll for each message
            });
            messageListEl.scrollTop = messageListEl.scrollHeight;
        }

        function appendMessage(msg, scroll = true) {
            const messageListEl = document.getElementById('message-list');
            const container = document.createElement('div');
            container.className = 'message-container';
            if (msg.sender_username === state.currentUsername) {
                container.classList.add('sent');
            }

            let contentHTML = `<div class="message-content">${parseMentions(msg.text_content || '')}</div>`;
            if (msg.content_type === 'image' && msg.media_data_url) {
                contentHTML += `<img src="${msg.media_data_url}" style="max-width: 250px; cursor: pointer;" onclick="window.open('${msg.media_data_url}')">`;
            } else if (msg.content_type === 'file' && msg.media_data_url) {
                contentHTML += `<a href="${msg.media_data_url}" download="${msg.media_filename}">Download: ${msg.media_filename}</a>`;
            } else if (msg.content_type === 'ai_response') {
                 contentHTML = `<div class="message-content ai-response"><b>AI Response:</b><br>${parseMentions(msg.text_content)}</div>`;
            }
            
            const senderHTML = msg.sender_username === state.currentUsername ? '' : `<div class="message-sender" onclick="showUserProfile('${msg.sender_username}')">${msg.sender_username}</div>`;

            container.innerHTML = `
                <div class="message-bubble">
                    ${senderHTML}
                    ${contentHTML}
                    <div class="timestamp">${new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                </div>
            `;
            messageListEl.appendChild(container);
            if (scroll) messageListEl.scrollTop = messageListEl.scrollHeight;
        }
        
        function parseMentions(text) {
            // Sanitize text before inserting to prevent XSS from @mentions
            const sanitizedText = text.replace(/</g, "<").replace(/>/g, ">");
            return sanitizedText.replace(/@(\w+)/g, '<a href="#" onclick="event.preventDefault(); showUserProfile(\'$1\')">@$1</a>');
        }

        // --- CORE APP LOGIC ---
        async function initializeApp() {
            showView('app-container');
            document.getElementById('current-username-display').textContent = state.currentUsername;
            
            try {
                await loadChats();
                startPolling();
                startSyncing();
            } catch (error) {
                console.error("Critical error during app initialization:", error);
                alert("Could not initialize the app. Please try refreshing the page.");
            }
        }
        
        async function loadChats() {
            try {
                const newChats = await apiFetch('/api/chats');
                // A simple check to see if we need to re-render
                if(JSON.stringify(state.chats) !== JSON.stringify(newChats)){
                    state.chats = newChats;
                    renderChatList();
                }
            } catch (error) {
                console.error("Failed to load chats:", error);
                // Don't rethrow here, allow the app to run without initial chats
            }
        }
        
        async function selectChat(chatId) {
            if (state.activeChatId === chatId) return;
            state.activeChatId = chatId;
            renderChatList(); // To update active highlight
            document.getElementById('app-container').classList.add('chat-view-active');
            
            const chat = state.chats.find(c => c.id === chatId);
            document.getElementById('chat-title').textContent = chat.name;
            
            if (!state.messages[chatId]) {
                state.messages[chatId] = [];
                state.lastMessageId[chatId] = 0;
                try {
                    const messages = await apiFetch(`/api/messages/${chatId}`);
                    state.messages[chatId] = messages;
                    if(messages.length > 0) {
                        state.lastMessageId[chatId] = messages[messages.length - 1].id;
                    }
                } catch(e){
                     console.error(`Failed to load messages for chat ${chatId}`, e);
                }
            }
            renderMessages();
        }

        document.getElementById('back-to-chats').addEventListener('click', () => {
            document.getElementById('app-container').classList.remove('chat-view-active');
            state.activeChatId = null;
            renderChatList(); // un-highlight
        });

        function startPolling() {
            if (state.pollingInterval) clearInterval(state.pollingInterval);
            state.pollingInterval = setInterval(async () => {
                // Poll for chats to see new messages/chats from anyone
                await loadChats();

                // Poll for messages in the active chat
                if (!state.activeChatId) return;
                try {
                    const lastId = state.lastMessageId[state.activeChatId] || 0;
                    const newMessages = await apiFetch(`/api/messages/${state.activeChatId}?last_id=${lastId}`);
                    if (newMessages.length > 0) {
                        const messageListEl = document.getElementById('message-list');
                        const isScrolledToBottom = messageListEl.scrollHeight - messageListEl.clientHeight <= messageListEl.scrollTop + 5; // 5px tolerance

                        newMessages.forEach(msg => {
                            if(!state.messages[state.activeChatId].some(m => m.id === msg.id)){
                                state.messages[state.activeChatId].push(msg);
                                appendMessage(msg, false); // append without scrolling
                            }
                        });
                        state.lastMessageId[state.activeChatId] = newMessages[newMessages.length - 1].id;
                        
                        if (isScrolledToBottom) {
                            messageListEl.scrollTop = messageListEl.scrollHeight;
                        }
                    }
                } catch(error) {
                    console.error("Message polling failed:", error);
                }
            }, 3000);
        }

        function startSyncing() {
            const savedQueue = localStorage.getItem('messageQueue');
            if (savedQueue) state.messageQueue = JSON.parse(savedQueue);
            
            if(state.syncInterval) clearInterval(state.syncInterval);
            state.syncInterval = setInterval(async () => {
                if (state.messageQueue.length === 0 || !state.activeChatId) return;
                
                const messagesToSend = state.messageQueue.filter(m => m.chat_id === state.activeChatId);
                if (messagesToSend.length === 0) return;
                const otherMessages = state.messageQueue.filter(m => m.chat_id !== state.activeChatId);

                try {
                    await apiFetch('/api/messages', {
                        method: 'POST',
                        body: JSON.stringify({ chat_id: state.activeChatId, messages: messagesToSend })
                    });
                    state.messageQueue = otherMessages;
                    localStorage.setItem('messageQueue', JSON.stringify(state.messageQueue));
                } catch (error) {
                    console.error("Failed to sync messages:", error);
                }
            }, 5000);
        }

        document.getElementById('message-input-form').addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();
        });

        document.getElementById('message-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        async function sendMessage() {
            if(!state.activeChatId) {
                alert("Please select a chat first!");
                return;
            }
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if (!text && !file) return;

            if (text.startsWith('/ai ')) {
                const prompt = text.substring(4);
                input.value = '';
                try {
                    const aiResponse = await apiFetch('/api/ai', { method: 'POST', body: JSON.stringify({ prompt }) });
                    const aiMessage = {
                        sender_username: "AI", content_type: "ai_response",
                        text_content: aiResponse.response, timestamp: new Date().toISOString()
                    };
                    appendMessage(aiMessage);
                } catch (error) { alert(`AI Error: ${error.message}`); }
                return;
            }

            const message = {
                chat_id: state.activeChatId, sender_username: state.currentUsername,
                text_content: text, timestamp: new Date().toISOString()
            };

            if (file) {
                message.content_type = file.type.startsWith('image/') ? 'image' : 'file';
                message.media_filename = file.name;
                message.media_content = await fileToBase64(file);
                message.media_data_url = URL.createObjectURL(file);
            } else {
                message.content_type = 'text';
            }

            if (!state.messages[state.activeChatId]) state.messages[state.activeChatId] = [];
            state.messages[state.activeChatId].push(message);
            appendMessage(message);

            const queueMessage = { ...message };
            delete queueMessage.media_data_url;
            state.messageQueue.push(queueMessage);
            localStorage.setItem('messageQueue', JSON.stringify(state.messageQueue));

            input.value = '';
            fileInput.value = '';
        }
        
        // --- MODALS and PROFILE PANEL ---
        function showNewChatModal() { document.getElementById('new-chat-modal').classList.remove('hidden'); }
        function hideNewChatModal() { document.getElementById('new-chat-modal').classList.add('hidden'); }
        async function showSettingsModal() { 
            try {
                const profile = await apiFetch('/api/profile');
                document.getElementById('settings-bio').value = profile.bio || '';
                document.getElementById('settings-modal').classList.remove('hidden'); 
            } catch(e) { alert("Could not load your profile."); }
        }
        function hideSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        
        document.getElementById('new-chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const usernames = document.getElementById('new-chat-usernames').value.split(',').map(u => u.trim()).filter(Boolean);
            const groupName = document.getElementById('new-chat-group-name').value;
            try {
                const result = await apiFetch('/api/chats/create', { 
                    method: 'POST', body: JSON.stringify({ usernames, group_name: groupName })
                });
                await loadChats();
                selectChat(result.chat_id);
                hideNewChatModal();
            } catch (error) { alert(`Error creating chat: ${error.message}`); }
        });
        
        document.getElementById('settings-form').addEventListener('submit', async(e) => {
            e.preventDefault();
            const bio = document.getElementById('settings-bio').value;
            const pfpFile = document.getElementById('settings-pfp').files[0];
            let pfpB64 = null;
            if(pfpFile) pfpB64 = await fileToBase64(pfpFile);

            const payload = { bio };
            if(pfpB64) payload.profile_picture = `data:image/png;base64,${pfpB64}`;

            try {
                await apiFetch('/api/profile', { method: 'PUT', body: JSON.stringify(payload) });
                alert('Profile updated!');
                hideSettingsModal();
            } catch(error) { alert(`Error: ${error.message}`); }
        });

        async function showUserProfile(username) {
            try {
                const profile = await apiFetch(`/api/profile/${username}`);
                document.getElementById('profile-panel-username').textContent = profile.username;
                document.getElementById('profile-panel-bio').textContent = profile.bio || "No bio set.";
                const avatar = document.getElementById('profile-panel-avatar');
                avatar.src = profile.profile_picture ? `data:image/jpeg;base64,${profile.profile_picture}` : `https://api.dicebear.com/7.x/initials/svg?seed=${profile.username}`;
                document.getElementById('profile-panel').classList.add('visible');
            } catch(error) { alert(`Could not load profile: ${error.message}`); }
        }
        function hideProfilePanel() { document.getElementById('profile-panel').classList.remove('visible'); }


        // --- INITIALIZATION ---
        window.onload = () => {
            state.token = localStorage.getItem('authToken');
            state.currentUsername = localStorage.getItem('username');
            if (state.token && state.currentUsername) {
                initializeApp();
            } else {
                showView('auth-view');
            }
        };
    </script>
</body>
</html>
