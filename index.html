<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; }
        .hidden { display: none !important; }
        #app-container, #login-container { max-width: 1000px; margin: 20px auto; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        
        /* Login Screen */
        #login-container { padding: 40px; text-align: center; }
        #login-container h1 { margin-top: 0; }
        #login-container input { width: 80%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        #login-container button { padding: 12px 20px; border: none; background-color: #007bff; color: white; font-size: 16px; border-radius: 4px; cursor: pointer; }
        #login-container button:hover { background-color: #0056b3; }
        #login-error { color: red; margin-top: 10px; }
        
        /* Main App */
        #app-view { display: flex; height: 80vh; }
        #sidebar { width: 30%; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #chat-area { width: 70%; display: flex; flex-direction: column; }
        
        /* Sidebar */
        .sidebar-header { padding: 10px; border-bottom: 1px solid #ddd; }
        .sidebar-header input { width: calc(100% - 20px); padding: 8px; border: 1px solid #ccc; border-radius: 15px; }
        #search-results { max-height: 200px; overflow-y: auto; }
        #search-results div, #chat-list div { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; }
        #search-results div:hover, #chat-list div:hover { background-color: #f5f5f5; }
        #chat-list .active-chat { background-color: #e0e0e0; }
        .chat-list-title { padding: 10px 15px; font-weight: bold; color: #555; background-color: #f9f9f9; border-bottom: 1px solid #ddd; }

        /* Chat Area */
        #chat-header { padding: 15px; border-bottom: 1px solid #ddd; font-weight: bold; background: #f9f9f9; }
        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        #message-input-area { border-top: 1px solid #ddd; padding: 10px; display: flex; }
        #message-input-area input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; margin-right: 10px; }
        #message-input-area button { padding: 10px 15px; border-radius: 20px; border: none; background-color: #007bff; color: white; cursor: pointer; }

        /* Messages */
        .message { max-width: 70%; padding: 10px 15px; margin-bottom: 10px; border-radius: 18px; line-height: 1.4; }
        .message.sent { background-color: #007bff; color: white; align-self: flex-end; }
        .message.received { background-color: #e9e9eb; color: #333; align-self: flex-start; }
        .message.gemini { background-color: #e8f5e9; color: #1b5e20; align-self: flex-start; }
    </style>
</head>
<body>

    <div id="login-container">
        <h1>Welcome to Chat App</h1>
        <p>Please register or log in with your username.</p>
        <input type="text" id="username-input" placeholder="Enter your username">
        <br>
        <button onclick="handleAuth()">Login / Register</button>
        <div id="login-error"></div>
    </div>

    <div id="app-container" class="hidden">
        <div id="app-view">
            <div id="sidebar">
                <div class="sidebar-header">
                    <input type="text" id="search-input" placeholder="Search for users...">
                </div>
                <div id="search-results"></div>
                <div class="chat-list-title">Chats</div>
                <div id="chat-list" style="flex-grow: 1; overflow-y: auto;"></div>
            </div>
            <div id="chat-area">
                <div id="chat-header">Select a chat to start messaging</div>
                <div id="messages"></div>
                <div id="message-input-area" class="hidden">
                    <input type="text" id="message-input" placeholder="Type a message...">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // Use http://127.0.0.1:5000 for local dev, or your Render URL for production
    const API_URL = window.location.origin;

    let currentUser = null;
    let activeChat = { id: null, name: null, isGemini: false };
    
    // --- INITIALIZATION ---
    window.onload = function() {
        const storedUser = localStorage.getItem('currentUser');
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            showAppScreen();
        } else {
            showLoginScreen();
        }

        document.getElementById('search-input').addEventListener('input', handleSearch);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    };

    function showLoginScreen() {
        document.getElementById('login-container').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
    }

    async function showAppScreen() {
        document.getElementById('login-container').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        await loadChats();
    }

    // --- AUTHENTICATION ---
    async function handleAuth() {
        const username = document.getElementById('username-input').value.trim();
        if (!username) {
            document.getElementById('login-error').textContent = 'Username cannot be empty.';
            return;
        }

        // Try to log in first
        let response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username })
        });

        if (response.ok) {
            currentUser = await response.json();
        } else {
            // If login fails (user not found), try to register
            response = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username })
            });
            if (response.ok) {
                currentUser = await response.json();
            } else {
                const error = await response.json();
                document.getElementById('login-error').textContent = `Error: ${error.error}`;
                return;
            }
        }
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showAppScreen();
    }

    // --- CHAT & USER MANAGEMENT ---
    async function handleSearch() {
        const query = document.getElementById('search-input').value.trim();
        const searchResultsDiv = document.getElementById('search-results');
        
        if (query.length < 2) {
            searchResultsDiv.innerHTML = '';
            return;
        }

        const response = await fetch(`${API_URL}/users/search?q=${query}&current_user_id=${currentUser.id}`);
        const users = await response.json();
        
        searchResultsDiv.innerHTML = '';
        users.forEach(user => {
            const userDiv = document.createElement('div');
            userDiv.textContent = user.username;
            userDiv.onclick = () => startChatWithUser(user.id, user.username);
            searchResultsDiv.appendChild(userDiv);
        });
    }

    async function startChatWithUser(otherUserId, otherUsername) {
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';

        const response = await fetch(`${API_URL}/chats/start`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user1_id: currentUser.id, user2_id: otherUserId })
        });
        const chatData = await response.json();
        
        await loadChats();
        openChat(chatData.chat_id, otherUsername, false);
    }
    
    async function loadChats() {
        const chatListDiv = document.getElementById('chat-list');
        chatListDiv.innerHTML = '';

        // Pinned Gemini Chat
        const geminiChat = document.createElement('div');
        geminiChat.textContent = "Chat with Gemini ✨";
        geminiChat.dataset.isGemini = true;
        geminiChat.onclick = () => openChat(null, "Chat with Gemini ✨", true);
        chatListDiv.appendChild(geminiChat);

        // User Chats
        const response = await fetch(`${API_URL}/chats?user_id=${currentUser.id}`);
        const chats = await response.json();
        
        chats.forEach(chat => {
            const chatDiv = document.createElement('div');
            chatDiv.textContent = chat.name;
            chatDiv.dataset.chatId = chat.id;
            chatDiv.dataset.chatName = chat.name;
            chatDiv.onclick = () => openChat(chat.id, chat.name, false);
            chatListDiv.appendChild(chatDiv);
        });
        
        updateActiveChatHighlight();
    }

    // --- MESSAGING ---
    function openChat(chatId, chatName, isGemini) {
        activeChat = { id: chatId, name: chatName, isGemini: isGemini };
        
        document.getElementById('chat-header').textContent = chatName;
        document.getElementById('message-input-area').classList.remove('hidden');
        
        if (isGemini) {
            document.getElementById('messages').innerHTML = '<div class="message gemini">Hi! How can I help you today?</div>';
        } else {
            loadMessages(chatId);
        }
        updateActiveChatHighlight();
    }
    
    async function loadMessages(chatId) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = 'Loading...';

        const response = await fetch(`${API_URL}/chats/${chatId}/messages`);
        const messages = await response.json();
        renderMessages(messages);
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();
        if (!content) return;
        
        input.value = '';

        if (activeChat.isGemini) {
            // Display user message immediately
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message sent';
            userMessageDiv.textContent = content;
            document.getElementById('messages').appendChild(userMessageDiv);
            
            // Send to Gemini API
            const response = await fetch(`${API_URL}/gemini-chat`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ content: content })
            });
            const geminiResponse = await response.json();

            const geminiMessageDiv = document.createElement('div');
            geminiMessageDiv.className = 'message gemini';
            geminiMessageDiv.textContent = geminiResponse.content;
            document.getElementById('messages').appendChild(geminiMessageDiv);

        } else {
            // Standard user-to-user chat
            await fetch(`${API_URL}/messages`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    content: content,
                    sender_id: currentUser.id,
                    chat_id: activeChat.id
                })
            });
            await loadMessages(activeChat.id);
        }
    }

    function renderMessages(messages) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';
        messages.forEach(msg => {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            msgDiv.classList.add(msg.sender_id === currentUser.id ? 'sent' : 'received');
            msgDiv.textContent = msg.content;
            messagesDiv.appendChild(msgDiv);
        });
        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function updateActiveChatHighlight() {
        document.querySelectorAll('#chat-list div').forEach(div => {
            const isGeminiDiv = div.dataset.isGemini === 'true';
            const divChatId = parseInt(div.dataset.chatId, 10);
            
            if ((activeChat.isGemini && isGeminiDiv) || (divChatId === activeChat.id && !activeChat.isGemini)) {
                div.classList.add('active-chat');
            } else {
                div.classList.remove('active-chat');
            }
        });
    }

</script>
</body>
</html>
